name: Build Release Binaries

on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  build-release:
    runs-on: ubuntu-18.04
    strategy:
      matrix:
        arch: [x64, x86]
    
    steps:
      - uses: actions/checkout@v2
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            autoconf \
            automake \
            gcc-multilib \
            g++-multilib \
            libtool \
            libjansson-dev \
            libmagic-dev \
            libssl-dev \
            protobuf-compiler \
            protobuf-c-compiler \
            libprotobuf-c-dev
      
      - name: Install 32-bit libraries for x86
        if: matrix.arch == 'x86'
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y \
            libjansson-dev:i386 \
            libmagic-dev:i386 \
            libssl-dev:i386 \
            libprotobuf-c-dev:i386
      
      - name: Bootstrap
        run: ./bootstrap.sh
      
      - name: Configure
        run: |
          if [ "${{ matrix.arch }}" = "x86" ]; then
            CFLAGS="-m32 -O2" CXXFLAGS="-m32 -O2" LDFLAGS="-m32" ./configure
          else
            CFLAGS="-O2" CXXFLAGS="-O2" ./configure
          fi
      
      - name: Build
        run: make clean && make
      
      - name: Strip binaries (release optimization)
        run: |
          if [ -f "yara" ]; then
            strip yara || true
          fi
      
      - name: Check binary architecture
        run: |
          if [ -f "yara" ]; then
            file yara
            ./yara --version || true
          fi
      
      - name: Create release archive
        run: |
          if [ -f "yara" ]; then
            tar czf yara-${{ github.ref_name }}-linux-${{ matrix.arch }}.tar.gz yara
            echo "Archive created: yara-${{ github.ref_name }}-linux-${{ matrix.arch }}.tar.gz"
          fi
      
      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            yara-${{ github.ref_name }}-linux-${{ matrix.arch }}.tar.gz
